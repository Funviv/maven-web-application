pipeline{
  agent any
  tools {
    maven "maven 3.8.4"
  }
  stages{
    stage('codecheckout'){
      steps{
        sh  "echo cloning the latest applications version"
        git 'https://github.com/Landmark-Finetech/maven-web-application.git'
      }
    }
    stage('TestBuild'){
      steps{
        sh  "echo Running unitTesting"
        sh  "echo unitTesting ok. Creating packages"
        sh  "mvn clean package"
        sh  "echo Artifacts created"    
      }
    }
    stage('codeQuality'){
        steps{
        sh  "echo Running codeQality report"
        sh  "mvn sonar:sonar"  
      }
    }
   stage('upLoadArtifacts'){
   steps{
   sh  "echo upLoadArtifacts into nexus"
   sh  "mvn deploy"  
      }      
    }
    stage('message'){
      steps{
        sh "echo CI job successful"
      }
    }
    stage('predeployment'){
        steps{
          sh "docker build -t kidunnu/maven-web-app . "
          sh "docker push kidunnu/maven-web-app:latest"
        }
      }    
  stage('UnDeploy'){
      steps{
        sh "echo UNDEPLOYING existing application"
        sh "docker rm -f maven-web-app"
      }
    }
stage('Predeployment'){ 
        steps{ 
        sh "echo Build docker image" 
        sh "docker rm -f myapp"
        sh "docker rm -f kidunnu/maven-web-app:latest"
        sh "docker rmi -f kidunnu/maven-web-app:latest"
        sh "docker build -t kidunnu/maven-web-app:latest ."
        sh "docker push kidunnu/maven-web-app:latest"
        sh "docker run --name myapp -d -p 8888:8080 joveluro/maven-web-app:latest"
        sh "aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 137620357192.dkr.ecr.us-east-2.amazonaws.com"
        sh "docker tag maven-web-app:latest 137620357192.dkr.ecr.us-east-2.amazonaws.com/maven-web-app:latest"
        sh "docker push 137620357192.dkr.ecr.us-east-2.amazonaws.com/maven-web-app:latest"
        } 
       } 
    stage('7. Slack Notification'){
        steps{
        sh "echo Start of Email Notification"
        slackSend channel: 'cicd-projects', message: 'Build Success'
    }
    }
